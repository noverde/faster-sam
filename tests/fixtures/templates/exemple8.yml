AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: Sample SAM Template for sam-api

Mappings:
  Environments:
    development:
      LogLevel: DEBUG
    staging:
      LogLevel: DEBUG
    production:
      LogLevel: INFO

Globals:
  Function:
    Environment:
      Variables:
        ENVIRONMENT:
          Ref: Environment
        LOG_LEVEL:
          Fn::FindInMap:
            - Environments
            - Ref: Environment
            - LogLevel
        DEFAULT_QUEUE:
          Ref: DefaultPriorityQueue
        ZENVIA_SECRET: "parameters:///platform/"
        FIREBASE_CREDENTIALS: "secrets://platform-notification/firebase-credentials"
        ELASTIC_APM_SERVICE_NAME: platform

Resources:
  DefaultPriorityQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: "platform-notifications-default-queue"
      VisibilityTimeout: 50
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt: DefaultPriorityDLQ.Arn
        maxReceiveCount: 5

  HelloWorldFunction:
    Type: AWS::Serverless::Function
    Properties:
      Environment:
          Variables:
              ELASTIC_APM_SEND_STRATEGY: background
      CodeUri: tests/
      Handler: fixtures.handlers.lambda_handler.handler
      Runtime: python3.11
      Architectures:
        - x86_64
      Events:
        HelloWorld:
          Type: Api
          Properties:
            Path: /hello
            Method: get
